# .github/workflows/ci.yml
# Corrigido o erro de caminho 'vercel/actions/deploy@v2'

name: CI/CD com Jest e Deploy na Vercel

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Integra√ß√£o Cont√≠nua (CI)
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Instalar depend√™ncias (incluindo Jest)
        run: npm install

      - name: 4. Corrigir permiss√£o de execu√ß√£o do Jest
        run: chmod +x node_modules/.bin/jest

      - name: 5. Executar testes com Jest
        run: npm test

  deploy:
    name: Implanta√ß√£o Cont√≠nua (CD) na Vercel
    runs-on: ubuntu-latest
    
    needs: build-and-test 
    
    steps:
      - name: 1. Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js (necess√°rio para a Action da Vercel)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Deploy para Produ√ß√£o na Vercel
        # =========================================================
        # üí• CORRE√á√ÉO: Usando o caminho atualizado 'vercel/actions/build' seguido de 'vercel/actions/deploy'
        # =========================================================
        # Para evitar problemas de caminho, o fluxo da Vercel agora usa dois passos separados.

      - name: 4. Vercel Build (Prepara a aplica√ß√£o)
        uses: vercel/actions/build@v1 # NOVO CAMINHO
      
      - name: 5. Deploy para Produ√ß√£o (Implanta a aplica√ß√£o)
        uses: vercel/actions/deploy-with-prebuilt@v1 # NOVO CAMINHO
        with:
          token: ${{ secrets.VERCEL_TOKEN }}
          org-id: ${{ secrets.VERCEL_ORG_ID }}
          project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          prod: true # Define como deploy de produ√ß√£o