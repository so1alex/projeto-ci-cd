# .github/workflows/ci.yml
# Corrigido o erro de permiss칚o 'jest: Permission denied'

name: CI/CD com Jest e Deploy na Vercel

on:
  push:
    branches:
      - main

jobs:
  # --- 1. JOB DE INTEGRA칂츾O CONT칈NUA (CI): Build e Testes ---
  build-and-test:
    name: Integra칞칚o Cont칤nua (CI)
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout do c칩digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Instalar depend칡ncias (incluindo Jest)
        run: npm install

      # =========================================================
      # 游눤 PASSO DE CORRE칂츾O: Adiciona permiss칚o de execu칞칚o ao Jest 
      # =========================================================
      - name: 4. Corrigir permiss칚o de execu칞칚o do Jest
        # O 'chmod +x' adiciona a permiss칚o de execu칞칚o (eXecute) 
        # ao bin치rio do Jest dentro da pasta de m칩dulos.
        run: chmod +x node_modules/.bin/jest

      - name: 5. Executar testes com Jest
        run: npm test

  # --- 2. JOB DE IMPLANTA칂츾O CONT칈NUA (CD): Deploy na Vercel ---
  deploy:
    name: Implanta칞칚o Cont칤nua (CD) na Vercel
    runs-on: ubuntu-latest
    
    # Este job s칩 ser치 executado SE o job `build-and-test` for conclu칤do com sucesso.
    needs: build-and-test 
    
    steps:
      - name: 1. Checkout do c칩digo
        uses: actions/checkout@v4

      - name: 2. Configurar Node.js (necess치rio para a Action da Vercel)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 3. Deploy para Produ칞칚o na Vercel
        uses: vercel/actions/deploy@v2
        with:
          token: ${{ secrets.VERCEL_TOKEN }}
          org-id: ${{ secrets.VERCEL_ORG_ID }}
          project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          prod: true